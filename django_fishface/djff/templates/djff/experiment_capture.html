{% extends "djff/base.html" %}
{% load staticfiles %}
{% load djff_filters %}

{% block subtitle %}Experiment Details{% endblock %}



{% block content %}
    <h1>
        <a href="{% url 'djff:experiment_rename' xp.id %}">
            {{ xp.experiment_name }}
        </a>
    </h1>

    {% if not cal_images %}
        <div class="boxed bad">
            <p>The first image captured for an experiment must be
        a <em>calibration image</em>.  No fish should be in the flume,
        but otherwise the configuration of the lighting, etc.
        should be exactly as it will be during the data capture.</p>

            <p>When you're ready to capture a calibration image, check the
        box below and click on the button.</p>
        </div>
    {% endif %}
    <div class="boxed">
    <form method="post"
          action="{% url 'djff:experiment_capturer' %}">
        {% csrf_token %}

        <input type="hidden" value="0" name="voltage">
        <input type="hidden" value="True" name="is_cal_image">
        <input type="checkbox" value="True" name="cal_ready">
        Ready to capture calibration image (no fish):
        <input type="hidden" value="{{ xp.id }}" name="xp_id">
        <input type="submit" value="Capture a calibration image" />
    </form>

    {% if cal_images %}
        <p>Calibration images:</p>
        {% for img in cal_images %}
            {{ img.linked_inline_image|replace_width:"20"|mark_safe }}
        {% endfor %}
    {% else %}
        <p>No cal images.</p>
    {% endif %}
    </div>

    <br>

    <div class="boxed">
    {% if not running_jobs and cal_images and capturejob_templates %}
    <ol>
    {% for cjt in capturejob_templates %}
        <li>
        <form method="post" action="{% url 'djff:run_capturejob' xp.id cjt.id %}">
        {% csrf_token %}
            Duration: {{ cjt.duration }},
            Interval: {{ cjt.interval }},
            Voltage: {{ cjt.voltage }}
        <input type="submit" value="Run this capture job" />
        </form>
        </li>
    {% endfor %}
    </ol>

    {% elif running_jobs %}
        {% for cjr in running_jobs %}
            <strong>Active capture job:</strong><br>
            <em>Voltage</em>: {{ cjr.voltage }}<br>
            <em>Remaining</em>: {{ cjr.remaining }}/{{ cjr.total }}
        {% endfor %}
    {% elif not cal_images %}
        Please capture a calibration image before viewing the capture jobs.
    {% endif %}
    </div>

    <h3>Capture Jobs</h3>
    <hr width="30%" />

    {% for cjr, imageset in images_by_cjr %}
        Started: {{ cjr.job_start }}<br>
        Completed: {{ cjr.job_stop }}<br>
        Captured {{ imageset.count }} images at {{ cjr.voltage }} volts:<br>
        {% for img in imageset %}
            {{ img.linked_inline_bullet|mark_safe }}
        {% endfor %}
        <hr width="30%" />
    {% empty %}
        <p>No capture jobs have been run for this experiment.</p>
    {% endfor %}

{% endblock %}

{% block preview_area %}
{% endblock %}